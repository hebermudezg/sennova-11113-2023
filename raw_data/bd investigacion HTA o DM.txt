WITH HISTORIARCV as (
SELECT 
TMHISTORIAS.vkpnumero
, TMHISTORIAS.nkpslinea
,TMHISTORIAS.TMUSUARI_TERC_VKPCODIGO
FROM  TMHISTORIAS,
        (  select  historia_vkpnumero  , historia_nkpslinea , VCONFIG_VKPCODIGO from TMHISTORIASPROGRAMAS where  FRFACTURA ='S' ) HistoriasProgramas,
        (SELECT TMTIPHISTORIASESTATUS.THISTOR_VKPCODIGO , TVCONFIGURACIONES.VKPCODIGO , TVCONFIGURACIONES.VRNOMBRE FROM TMTIPHISTORIASESTATUS ,  TVCONFIGURACIONES
        WHERE TMTIPHISTORIASESTATUS.THISTOR_VKPCODIGO = TVCONFIGURACIONES.THISTOR_VKPCODIGO AND TMTIPHISTORIASESTATUS.YCONFIG_VKPCODIGO = 'HIS_ENFCRONI' )  HISTORIASRCV
 WHERE HistoriasProgramas.HISTORIA_NKPSLINEA(+) = TMHISTORIAS.NKPSLINEA
    AND HistoriasProgramas.HISTORIA_VKPNUMERO(+) = TMHISTORIAS.VKPNUMERO
    AND ( HistoriasProgramas.VCONFIG_VKPCODIGO = HISTORIASRCV.VKPCODIGO OR  TMHISTORIAS.MOD_VKPCODIGO = HISTORIASRCV.VKPCODIGO)
    AND TRUNC(TMHISTORIAS.DRFECHA)     >=  '01/01/2019' 
)

select 
TMHISTORIASDIAGNOSTICOS.HISTORIA_VKPNUMERO
,TMHISTORIASDIAGNOSTICOS.HISTORIA_NKPSLINEA
,TMHISTORIAS.DRFECHA
,TMHISTORIASDIAGNOSTICOS.ENFERMEDAD_VKPCODIGO
,TMHISTORIASDIAGNOSTICOS.TMTIPOSDIA_VKPCODIGO
,TMHISTORIAS.NPESO
,TMHISTORIAS.NTALLA
,TMHISTORIAS.NIMC
,TMHISTORIAS.NPASS
,TMHISTORIAS.NPADS
,TMHISTORIAS.NPULSO
,TMHISTORIAS.NFRD
,TMHISTORIAS.NCINTURA
,DECODE(TVENFERMEDADESCRONICAS.FRTABAQUISMO,'S','Si','N','No',NULL,'No Aplica') "TABAQUISMO"
,tmusuarios.DTRNACIMIENTO
,tmusuarios.VRXSEXO
,TVUCIALABORATORIOS.*


FROM  TMHISTORIAS, TMHISTORIASDIAGNOSTICOS,
        tmusuarios,
        TVUCIALABORATORIOS,
        TVENFERMEDADESCRONICAS,
        HISTORIARCV
 WHERE HISTORIARCV.VKPNUMERO=TMHISTORIAS.VKPNUMERO
    and HISTORIARCV.NKPSLINEA=TMHISTORIAS.NKPSLINEA
    and HISTORIARCV.VKPNUMERO = TMHISTORIASDIAGNOSTICOS.HISTORIA_VKPNUMERO
    AND HISTORIARCV.NKPSLINEA = TMHISTORIASDIAGNOSTICOS.HISTORIA_NKPSLINEA
    AND TMHISTORIASDIAGNOSTICOS.ENFERMEDAD_VKPCODIGO is not null
    AND HISTORIARCV.TMUSUARI_TERC_VKPCODIGO = tmusuarios.TERC_VKPCODIGO
    AND HISTORIARCV.VKPNUMERO = TVUCIALABORATORIOS.HISTORIA_VKPNUMERO(+)
    AND HISTORIARCV.NKPSLINEA = TVUCIALABORATORIOS.HISTORIA_NKPSLINEA(+)
    AND HISTORIARCV.VKPNUMERO = TVENFERMEDADESCRONICAS.HISTORIA_VKPNUMERO(+)
    AND HISTORIARCV.NKPSLINEA = TVENFERMEDADESCRONICAS.HISTORIA_NKPSLINEA(+)